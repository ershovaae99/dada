<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DND Online RPG</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // Lucide icons as simple SVG components
    const Skull = () => <svg className="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-2-13h4v6h-4zm0 8h4v2h-4z" /></svg>;
    const Heart = ({ className }) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z" /></svg>;
    const Coins = ({ className }) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" strokeWidth={2}/></svg>;
    const ShoppingBag = ({ className }) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M16 11V7a4 4 0 0 0-8 0v4M5 9h14l1 12H4L5 9z" /></svg>;
    const Sword = ({ className }) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M20 4L4 20m0-16l16 16" /></svg>;
    const Shield = ({ className }) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 2L4 6v6c0 5 4 9 8 12 4-3 8-7 8-12V6l-8-4z" /></svg>;
    const Zap = ({ className }) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 2L3 14h8l-1 8 10-12h-8l1-8z" /></svg>;
    const User = ({ className }) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2M12 11a4 4 0 1 0 0-8 4 4 0 0 0 0 8z" /></svg>;
    const Wifi = ({ className }) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 20h.01M8.1 16.1a5 5 0 0 1 7.8 0M3.5 11.5a11 11 0 0 1 17 0" /></svg>;
    const WifiOff = ({ className }) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M1 1l22 22M16.7 16.7a5 5 0 0 1-7.4 0M3.5 11.5a11 11 0 0 1 3.2-2.4m6.6 0a11 11 0 0 1 7.2 2.4" /></svg>;
    const Copy = ({ className }) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><rect x="9" y="9" width="13" height="13" rx="2" ry="2" strokeWidth={2}/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1" strokeWidth={2}/></svg>;
    const Users = ({ className }) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2M23 21v-2a4 4 0 0 0-3-3.87M13 7a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM16 3.13a4 4 0 0 1 0 7.75" /></svg>;
    const Settings = ({ className }) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3" strokeWidth={2}/><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 1v6m0 6v6m-9-9h6m6 0h6" /></svg>;

    // –ü–û–ú–ï–ù–Ø–ô–¢–ï –≠–¢–û –ù–ê –í–ê–® FIREBASE URL
    const DEFAULT_FIREBASE_URL = 'https://games-1e88e-default-rtdb.firebaseio.com/';

    const DNDGame = () => {
      const [gameState, setGameState] = useState('config');
      const [firebaseUrl, setFirebaseUrl] = useState(DEFAULT_FIREBASE_URL);
      const [isHost, setIsHost] = useState(false);
      const [roomCode, setRoomCode] = useState('');
      const [inputRoomCode, setInputRoomCode] = useState('');
      const [myPlayerId, setMyPlayerId] = useState(null);
      const [selectedGenre, setSelectedGenre] = useState('');
      const [story, setStory] = useState('');
      const [loading, setLoading] = useState(false);
      const [currentPlayerIndex, setCurrentPlayerIndex] = useState(0);
      const [actionLog, setActionLog] = useState([]);
      const [playerAction, setPlayerAction] = useState('');
      const [connectionStatus, setConnectionStatus] = useState('disconnected');
      const [chatMessages, setChatMessages] = useState([]);
      const [chatInput, setChatInput] = useState('');
      
      const pollIntervalRef = useRef(null);
      
      const [players, setPlayers] = useState([
        { id: 1, name: '–ò–≥—Ä–æ–∫ 1', health: 100, strength: 10, agility: 10, intelligence: 10, gold: 50, inventory: [], connected: false },
        { id: 2, name: '–ò–≥—Ä–æ–∫ 2', health: 100, strength: 10, agility: 10, intelligence: 10, gold: 50, inventory: [], connected: false },
        { id: 3, name: '–ò–≥—Ä–æ–∫ 3', health: 100, strength: 10, agility: 10, intelligence: 10, gold: 50, inventory: [], connected: false },
        { id: 4, name: '–ò–≥—Ä–æ–∫ 4', health: 100, strength: 10, agility: 10, intelligence: 10, gold: 50, inventory: [], connected: false }
      ]);

      const genres = [
        { id: 'horror', name: '–•–æ—Ä—Ä–æ—Ä', desc: '–ú—Ä–∞—á–Ω—ã–µ –∫–æ—Ä–∏–¥–æ—Ä—ã, –¥—Ä–µ–≤–Ω–µ–µ –∑–ª–æ –∏ —É–∂–∞—Å–∞—é—â–∏–µ —Ç–∞–π–Ω—ã', icon: 'üèöÔ∏è' },
        { id: 'fantasy', name: '–§—ç–Ω—Ç–µ–∑–∏', desc: '–ú–∞–≥–∏—è, –¥—Ä–∞–∫–æ–Ω—ã –∏ —ç–ø–∏—á–µ—Å–∫–∏–µ –ø—Ä–∏–∫–ª—é—á–µ–Ω–∏—è', icon: 'üêâ' },
        { id: 'cyberpunk', name: '–ö–∏–±–µ—Ä–ø–∞–Ω–∫', desc: '–ù–µ–æ–Ω–æ–≤—ã–µ —É–ª–∏—Ü—ã, –∫–∏–±–æ—Ä–≥–∏ –∏ –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–µ –∑–∞–≥–æ–≤–æ—Ä—ã', icon: 'ü§ñ' },
        { id: 'postapoc', name: '–ü–æ—Å—Ç–∞–ø–æ–∫–∞–ª–∏–ø—Å–∏—Å', desc: '–í—ã–∂–∏–≤–∞–Ω–∏–µ –≤ —Ä–∞–∑—Ä—É—à–µ–Ω–Ω–æ–º –º–∏—Ä–µ', icon: '‚ò¢Ô∏è' }
      ];

      const shopItems = [
        { id: 1, name: '–ó–µ–ª—å–µ –∑–¥–æ—Ä–æ–≤—å—è', cost: 20, effect: 'health', value: 30, icon: 'üß™' },
        { id: 2, name: '–ú–µ—á', cost: 50, effect: 'strength', value: 5, icon: '‚öîÔ∏è' },
        { id: 3, name: '–õ–µ–≥–∫–∞—è –±—Ä–æ–Ω—è', cost: 40, effect: 'health', value: 20, icon: 'üõ°Ô∏è' },
        { id: 4, name: '–ê–º—É–ª–µ—Ç —É–¥–∞—á–∏', cost: 60, effect: 'agility', value: 5, icon: 'üíé' },
        { id: 5, name: '–ö–Ω–∏–≥–∞ –∑–∞–∫–ª–∏–Ω–∞–Ω–∏–π', cost: 55, effect: 'intelligence', value: 5, icon: 'üìñ' }
      ];

      const saveFirebaseConfig = () => {
        if (!firebaseUrl.trim()) {
          alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ URL Firebase');
          return;
        }
        
        let url = firebaseUrl.trim();
        if (!url.startsWith('http')) {
          url = 'https://' + url;
        }
        if (!url.endsWith('/')) {
          url = url + '/';
        }
        
        setFirebaseUrl(url);
        setGameState('menu');
      };

      const writeToFirebase = async (path, data) => {
        try {
          const response = await fetch(`${firebaseUrl}${path}.json`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
          
          if (!response.ok) {
            throw new Error('Firebase write failed');
          }
          
          return await response.json();
        } catch (error) {
          console.error('Firebase write error:', error);
          throw error;
        }
      };

      const readFromFirebase = async (path) => {
        try {
          const response = await fetch(`${firebaseUrl}${path}.json`);
          
          if (!response.ok) {
            throw new Error('Firebase read failed');
          }
          
          return await response.json();
        } catch (error) {
          console.error('Firebase read error:', error);
          throw error;
        }
      };

      const startPolling = (code) => {
        if (pollIntervalRef.current) {
          clearInterval(pollIntervalRef.current);
        }
        
        pollIntervalRef.current = setInterval(async () => {
          try {
            const data = await readFromFirebase(`rooms/${code}`);
            if (data) {
              setPlayers(data.players || players);
              setGameState(data.gameState || gameState);
              setSelectedGenre(data.selectedGenre || '');
              setStory(data.story || '');
              setActionLog(data.actionLog || []);
              setCurrentPlayerIndex(data.currentPlayerIndex || 0);
              setChatMessages(data.chatMessages || []);
            }
          } catch (error) {
            console.error('Polling error:', error);
          }
        }, 2000);
      };

      useEffect(() => {
        return () => {
          if (pollIntervalRef.current) {
            clearInterval(pollIntervalRef.current);
          }
        };
      }, []);

      const createRoom = async () => {
        const code = Math.random().toString(36).substring(2, 8).toUpperCase();
        setRoomCode(code);
        setIsHost(true);
        setMyPlayerId(1);
        setConnectionStatus('hosting');
        
        const updatedPlayers = [...players];
        updatedPlayers[0].connected = true;
        setPlayers(updatedPlayers);
        
        const roomData = {
          host: true,
          players: updatedPlayers,
          gameState: 'lobby',
          selectedGenre: '',
          story: '',
          actionLog: [],
          currentPlayerIndex: 0,
          chatMessages: [],
          createdAt: Date.now()
        };
        
        try {
          await writeToFirebase(`rooms/${code}`, roomData);
          setGameState('lobby');
          startPolling(code);
        } catch (error) {
          setConnectionStatus('error');
          alert('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–º–Ω–∞—Ç—ã. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ URL Firebase.');
        }
      };

      const joinRoom = async () => {
        if (!inputRoomCode.trim()) return;
        
        const code = inputRoomCode.toUpperCase();
        setRoomCode(code);
        setIsHost(false);
        setConnectionStatus('connecting');
        
        try {
          const roomData = await readFromFirebase(`rooms/${code}`);
          
          if (!roomData) {
            throw new Error('Room not found');
          }
          
          setPlayers(roomData.players);
          setGameState('lobby');
          setConnectionStatus('connected');
          startPolling(code);
        } catch (error) {
          setConnectionStatus('error');
          alert('–ö–æ–º–Ω–∞—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–¥.');
        }
      };

      const updateFirebase = async (updates) => {
        if (!roomCode) return;
        
        try {
          const currentData = await readFromFirebase(`rooms/${roomCode}`);
          const newData = { ...currentData, ...updates };
          await writeToFirebase(`rooms/${roomCode}`, newData);
        } catch (error) {
          console.error('Update error:', error);
        }
      };

      const selectPlayerSlot = async (slotId) => {
        if (players[slotId - 1].connected && myPlayerId !== slotId) {
          alert('–≠—Ç–æ—Ç —Å–ª–æ—Ç —É–∂–µ –∑–∞–Ω—è—Ç!');
          return;
        }
        
        const updatedPlayers = [...players];
        
        if (myPlayerId) {
          updatedPlayers[myPlayerId - 1].connected = false;
        }
        
        updatedPlayers[slotId - 1].connected = true;
        setMyPlayerId(slotId);
        setPlayers(updatedPlayers);
        
        await updateFirebase({ players: updatedPlayers });
      };

      const sendChatMessage = async () => {
        if (!chatInput.trim()) return;
        
        const message = {
          player: `–ò–≥—Ä–æ–∫ ${myPlayerId}`,
          text: chatInput,
          timestamp: Date.now()
        };
        
        const newMessages = [...chatMessages, message];
        setChatMessages(newMessages);
        setChatInput('');
        
        await updateFirebase({ chatMessages: newMessages });
      };

      const generateStory = async (genre) => {
        if (!isHost) return;
        
        setLoading(true);
        try {
          const genrePrompts = {
            horror: '–∂—É—Ç–∫–∏–π —Ö–æ—Ä—Ä–æ—Ä —Å –º–∏—Å—Ç–∏—á–µ—Å–∫–∏–º–∏ —ç–ª–µ–º–µ–Ω—Ç–∞–º–∏, –∑–∞–±—Ä–æ—à–µ–Ω–Ω—ã–º–∏ –º–µ—Å—Ç–∞–º–∏ –∏ –¥—Ä–µ–≤–Ω–∏–º –∑–ª–æ–º',
            fantasy: '—ç–ø–∏—á–µ—Å–∫–æ–µ —Ñ—ç–Ω—Ç–µ–∑–∏ –ø—Ä–∏–∫–ª—é—á–µ–Ω–∏–µ —Å –º–∞–≥–∏–µ–π, –º–∏—Ñ–∏—á–µ—Å–∫–∏–º–∏ —Å—É—â–µ—Å—Ç–≤–∞–º–∏ –∏ –¥—Ä–µ–≤–Ω–∏–º–∏ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞–º–∏',
            cyberpunk: '–º—Ä–∞—á–Ω—ã–π –∫–∏–±–µ—Ä–ø–∞–Ω–∫ —Å –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–º–∏ –∏–Ω—Ç—Ä–∏–≥–∞–º–∏, —Ö–∞–∫–µ—Ä–∞–º–∏ –∏ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–º –±–µ—Å–ø—Ä–µ–¥–µ–ª–æ–º',
            postapoc: '–ø–æ—Å—Ç–∞–ø–æ–∫–∞–ª–∏–ø—Ç–∏—á–µ—Å–∫–∏–π –º–∏—Ä —Å –≤—ã–∂–∏–≤–∞–Ω–∏–µ–º, –º—É—Ç–∞–Ω—Ç–∞–º–∏ –∏ –ø–æ–∏—Å–∫–æ–º —Ä–µ—Å—É—Ä—Å–æ–≤'
          };

          const response = await fetch("https://api.anthropic.com/v1/messages", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              model: "claude-sonnet-4-20250514",
              max_tokens: 2000,
              messages: [
                {
                  role: "user",
                  content: `–°–æ–∑–¥–∞–π —É–Ω–∏–∫–∞–ª—å–Ω—ã–π —Å—é–∂–µ—Ç –¥–ª—è —Ç–µ–∫—Å—Ç–æ–≤–æ–π RPG –∏–≥—Ä—ã –≤ –∂–∞–Ω—Ä–µ ${genrePrompts[genre]}. 
                  
                  –í –∏–≥—Ä–µ —É—á–∞—Å—Ç–≤—É—é—Ç 4 –∏–≥—Ä–æ–∫–∞. –û–ø–∏—à–∏:
                  1. –ù–∞—á–∞–ª—å–Ω—É—é –ª–æ–∫–∞—Ü–∏—é –∏ –∞—Ç–º–æ—Å—Ñ–µ—Ä—É (2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è)
                  2. –ì–ª–∞–≤–Ω—É—é —É–≥—Ä–æ–∑—É –∏–ª–∏ —Ü–µ–ª—å –ø—Ä–∏–∫–ª—é—á–µ–Ω–∏—è
                  3. –ü–µ—Ä–≤—É—é —Å–∏—Ç—É–∞—Ü–∏—é, —Å –∫–æ—Ç–æ—Ä–æ–π —Å—Ç–æ–ª–∫–Ω—É–ª–∏—Å—å –∏–≥—Ä–æ–∫–∏
                  
                  –°–¥–µ–ª–∞–π –æ–ø–∏—Å–∞–Ω–∏–µ –∞—Ç–º–æ—Å—Ñ–µ—Ä–Ω—ã–º –∏ –∑–∞—Ö–≤–∞—Ç—ã–≤–∞—é—â–∏–º. –¢–µ–∫—Å—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ.`
                }
              ]
            })
          });

          const data = await response.json();
          const generatedStory = data.content[0].text;
          
          setStory(generatedStory);
          const newLog = [{ type: 'story', text: generatedStory }];
          setActionLog(newLog);
          setGameState('playing');
          
          await updateFirebase({
            story: generatedStory,
            actionLog: newLog,
            gameState: 'playing'
          });
        } catch (error) {
          console.error('Error generating story:', error);
          setStory('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å—é–∂–µ—Ç–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
        }
        setLoading(false);
      };

      const handleAction = async () => {
        if (!playerAction.trim() || myPlayerId !== currentPlayerIndex + 1) return;

        const currentPlayer = players[currentPlayerIndex];
        setLoading(true);

        const newLog = [...actionLog, { 
          type: 'action', 
          player: currentPlayer.name, 
          text: playerAction 
        }];
        setActionLog(newLog);
        setPlayerAction('');

        try {
          const gameHistory = actionLog.map(log => {
            if (log.type === 'story') return `–°—é–∂–µ—Ç: ${log.text}`;
            if (log.type === 'action') return `${log.player}: ${log.text}`;
            if (log.type === 'result') return `–†–µ–∑—É–ª—å—Ç–∞—Ç: ${log.text}`;
            return '';
          }).join('\\n\\n');

          const playersInfo = players.map(p => 
            `${p.name}: –ó–¥–æ—Ä–æ–≤—å–µ ${p.health}, –°–∏–ª–∞ ${p.strength}, –õ–æ–≤–∫–æ—Å—Ç—å ${p.agility}, –ò–Ω—Ç–µ–ª–ª–µ–∫—Ç ${p.intelligence}, –ó–æ–ª–æ—Ç–æ ${p.gold}`
          ).join('\\n');

          const response = await fetch("https://api.anthropic.com/v1/messages", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              model: "claude-sonnet-4-20250514",
              max_tokens: 1500,
              messages: [
                {
                  role: "user",
                  content: `–¢—ã - –º–∞—Å—Ç–µ—Ä DND –∏–≥—Ä—ã. –í–æ—Ç —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã:

–ò–°–¢–û–†–ò–Ø –ò–ì–†–´:
${gameHistory}

–°–û–°–¢–û–Ø–ù–ò–ï –ò–ì–†–û–ö–û–í:
${playersInfo}

–î–ï–ô–°–¢–í–ò–ï –¢–ï–ö–£–©–ï–ì–û –ò–ì–†–û–ö–ê (${currentPlayer.name}):
${playerAction}

–û–ø–∏—à–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç —ç—Ç–æ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è (2-4 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è). –í–∫–ª—é—á–∏:
1. –ß—Ç–æ –ø—Ä–æ–∏–∑–æ—à–ª–æ –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ –¥–µ–π—Å—Ç–≤–∏—è
2. –ï—Å–ª–∏ –Ω—É–∂–Ω–æ, –∏–∑–º–µ–Ω–∏ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –∏–≥—Ä–æ–∫–∞ (—É—Ä–æ–Ω/–∏—Å—Ü–µ–ª–µ–Ω–∏–µ/–Ω–∞–≥—Ä–∞–¥–∞)
3. –†–∞–∑–≤–∏—Ç–∏–µ —Å—é–∂–µ—Ç–∞

–í –∫–æ–Ω—Ü–µ –æ—Ç–≤–µ—Ç–∞ –¥–æ–±–∞–≤—å –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫ (–µ—Å–ª–∏ –µ—Å—Ç—å):
{"healthChange": —á–∏—Å–ª–æ, "goldChange": —á–∏—Å–ª–æ}

–ï—Å–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π –Ω–µ—Ç, –∏—Å–ø–æ–ª—å–∑—É–π 0. –ü–∏—à–∏ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ.`
                }
              ]
            })
          });

          const data = await response.json();
          let resultText = data.content[0].text;
          
          const jsonMatch = resultText.match(/\\{[^}]*"healthChange"[^}]*\\}/);
          let changes = { healthChange: 0, goldChange: 0 };
          
          if (jsonMatch) {
            try {
              changes = JSON.parse(jsonMatch[0]);
              resultText = resultText.replace(jsonMatch[0], '').trim();
            } catch (e) {
              console.log('Could not parse changes');
            }
          }

          const updatedPlayers = [...players];
          updatedPlayers[currentPlayerIndex] = {
            ...currentPlayer,
            health: Math.max(0, Math.min(100, currentPlayer.health + (changes.healthChange || 0))),
            gold: Math.max(0, currentPlayer.gold + (changes.goldChange || 0))
          };
          
          const finalLog = [...newLog, { type: 'result', text: resultText }];
          const nextPlayerIndex = (currentPlayerIndex + 1) % 4;
          
          setPlayers(updatedPlayers);
          setActionLog(finalLog);
          setCurrentPlayerIndex(nextPlayerIndex);

          await updateFirebase({
            actionLog: finalLog,
            currentPlayerIndex: nextPlayerIndex,
            players: updatedPlayers
          });
        } catch (error) {
          console.error('Error processing action:', error);
          setActionLog([...newLog, { type: 'result', text: '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –¥–µ–π—Å—Ç–≤–∏—è.' }]);
        }
        setLoading(false);
      };

      const buyItem = async (item) => {
        if (myPlayerId === null) return;
        
        const playerIndex = myPlayerId - 1;
        const currentPlayer = players[playerIndex];
        
        if (currentPlayer.gold < item.cost) {
          alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∑–æ–ª–æ—Ç–∞!');
          return;
        }

        const updatedPlayers = [...players];
        const playerToUpdate = updatedPlayers[playerIndex];
        
        playerToUpdate.gold -= item.cost;
        playerToUpdate.inventory.push(item.name);
        
        if (item.effect === 'health') {
          playerToUpdate.health = Math.min(100, playerToUpdate.health + item.value);
        } else if (item.effect === 'strength') {
          playerToUpdate.strength += item.value;
        } else if (item.effect === 'agility') {
          playerToUpdate.agility += item.value;
        } else if (item.effect === 'intelligence') {
          playerToUpdate.intelligence += item.value;
        }
        
        setPlayers(updatedPlayers);
        await updateFirebase({ players: updatedPlayers });
      };

      const copyRoomCode = () => {
        navigator.clipboard.writeText(roomCode);
        alert('–ö–æ–¥ –∫–æ–º–Ω–∞—Ç—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!');
      };

      const handleGenreSelect = async (genreId) => {
        setSelectedGenre(genreId);
        if (isHost) {
          await updateFirebase({ selectedGenre: genreId });
        }
      };

      const startGame = async () => {
        if (!isHost) return;
        setGameState('setup');
        await updateFirebase({ gameState: 'setup' });
      };

      // Render logic here - –≤—Å–µ —ç–∫—Ä–∞–Ω—ã –∏–≥—Ä—ã
      // ... (–æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ —Å —Ä–µ–Ω–¥–µ—Ä–æ–º –∏–≥—Ä—ã —Ç–æ—á–Ω–æ —Ç–∞–∫–æ–π –∂–µ –∫–∞–∫ –≤ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–µ)
      
      if (gameState === 'config') {
        return (
          <div className="min-h-screen bg-gradient-to-b from-gray-900 via-purple-900 to-black text-white p-8">
            <div className="max-w-2xl mx-auto">
              <div className="text-center mb-12">
                <Settings className="w-20 h-20 mx-auto mb-4 text-blue-500" />
                <h1 className="text-5xl font-bold mb-4 text-red-500">–ù–∞—Å—Ç—Ä–æ–π–∫–∞ Firebase</h1>
                <p className="text-xl text-gray-300 mb-8">–í–≤–µ–¥–∏—Ç–µ URL –≤–∞—à–µ–π Firebase Realtime Database</p>
              </div>

              <div className="bg-gray-800 border-2 border-gray-700 rounded-lg p-8 mb-6">
                <input
                  type="text"
                  value={firebaseUrl}
                  onChange={(e) => setFirebaseUrl(e.target.value)}
                  placeholder="https://your-project.firebaseio.com"
                  className="w-full bg-gray-900 text-white border-2 border-gray-700 rounded p-4 mb-4 text-center"
                />
                
                <button
                  onClick={saveFirebaseConfig}
                  className="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-4 px-6 rounded-lg text-xl transition-all"
                >
                  –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å
                </button>
              </div>
            </div>
          </div>
        );
      }

      // –û—Å—Ç–∞–ª—å–Ω—ã–µ —ç–∫—Ä–∞–Ω—ã –∏–≥—Ä—ã (menu, lobby, setup, shop, playing)
      // –ü–æ–ª–Ω—ã–π –∫–æ–¥ —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π –¥–ª—è –æ–¥–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ - –ø—Ä–æ–¥–æ–ª–∂—É –≤ —Å–ª–µ–¥—É—é—â–µ–º –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–µ

      return <div>Loading...</div>;
    };

    ReactDOM.render(<DNDGame />, document.getElementById('root'));
  </script>
</body>
</html>
