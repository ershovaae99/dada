<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DND Online RPG</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // –ü–û–ú–ï–ù–Ø–ô–¢–ï –≠–¢–û –ù–ê –í–ê–® FIREBASE URL!
    const DEFAULT_FIREBASE_URL = 'https://games-1e88e-default-rtdb.firebaseio.com/';

    // Simple icon components
    const Icon = ({ d, className = "w-6 h-6" }) => (
      <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d={d} />
      </svg>
    );

    const DNDGame = () => {
      const [gameState, setGameState] = useState('config');
      const [firebaseUrl, setFirebaseUrl] = useState(DEFAULT_FIREBASE_URL);
      const [isHost, setIsHost] = useState(false);
      const [roomCode, setRoomCode] = useState('');
      const [inputRoomCode, setInputRoomCode] = useState('');
      const [myPlayerId, setMyPlayerId] = useState(null);
      const [selectedGenre, setSelectedGenre] = useState('');
      const [story, setStory] = useState('');
      const [loading, setLoading] = useState(false);
      const [currentPlayerIndex, setCurrentPlayerIndex] = useState(0);
      const [actionLog, setActionLog] = useState([]);
      const [playerAction, setPlayerAction] = useState('');
      const [connectionStatus, setConnectionStatus] = useState('disconnected');
      const [chatMessages, setChatMessages] = useState([]);
      const [chatInput, setChatInput] = useState('');
      
      const pollIntervalRef = useRef(null);
      
      const [players, setPlayers] = useState([
        { id: 1, name: '–ò–≥—Ä–æ–∫ 1', health: 100, strength: 10, agility: 10, intelligence: 10, gold: 50, inventory: [], connected: false },
        { id: 2, name: '–ò–≥—Ä–æ–∫ 2', health: 100, strength: 10, agility: 10, intelligence: 10, gold: 50, inventory: [], connected: false },
        { id: 3, name: '–ò–≥—Ä–æ–∫ 3', health: 100, strength: 10, agility: 10, intelligence: 10, gold: 50, inventory: [], connected: false },
        { id: 4, name: '–ò–≥—Ä–æ–∫ 4', health: 100, strength: 10, agility: 10, intelligence: 10, gold: 50, inventory: [], connected: false }
      ]);

      const genres = [
        { id: 'horror', name: '–•–æ—Ä—Ä–æ—Ä', desc: '–ú—Ä–∞—á–Ω—ã–µ –∫–æ—Ä–∏–¥–æ—Ä—ã, –¥—Ä–µ–≤–Ω–µ–µ –∑–ª–æ –∏ —É–∂–∞—Å–∞—é—â–∏–µ —Ç–∞–π–Ω—ã', icon: 'üèöÔ∏è' },
        { id: 'fantasy', name: '–§—ç–Ω—Ç–µ–∑–∏', desc: '–ú–∞–≥–∏—è, –¥—Ä–∞–∫–æ–Ω—ã –∏ —ç–ø–∏—á–µ—Å–∫–∏–µ –ø—Ä–∏–∫–ª—é—á–µ–Ω–∏—è', icon: 'üêâ' },
        { id: 'cyberpunk', name: '–ö–∏–±–µ—Ä–ø–∞–Ω–∫', desc: '–ù–µ–æ–Ω–æ–≤—ã–µ —É–ª–∏—Ü—ã, –∫–∏–±–æ—Ä–≥–∏ –∏ –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–µ –∑–∞–≥–æ–≤–æ—Ä—ã', icon: 'ü§ñ' },
        { id: 'postapoc', name: '–ü–æ—Å—Ç–∞–ø–æ–∫–∞–ª–∏–ø—Å–∏—Å', desc: '–í—ã–∂–∏–≤–∞–Ω–∏–µ –≤ —Ä–∞–∑—Ä—É—à–µ–Ω–Ω–æ–º –º–∏—Ä–µ', icon: '‚ò¢Ô∏è' }
      ];

      const shopItems = [
        { id: 1, name: '–ó–µ–ª—å–µ –∑–¥–æ—Ä–æ–≤—å—è', cost: 20, effect: 'health', value: 30, icon: 'üß™' },
        { id: 2, name: '–ú–µ—á', cost: 50, effect: 'strength', value: 5, icon: '‚öîÔ∏è' },
        { id: 3, name: '–õ–µ–≥–∫–∞—è –±—Ä–æ–Ω—è', cost: 40, effect: 'health', value: 20, icon: 'üõ°Ô∏è' },
        { id: 4, name: '–ê–º—É–ª–µ—Ç —É–¥–∞—á–∏', cost: 60, effect: 'agility', value: 5, icon: 'üíé' },
        { id: 5, name: '–ö–Ω–∏–≥–∞ –∑–∞–∫–ª–∏–Ω–∞–Ω–∏–π', cost: 55, effect: 'intelligence', value: 5, icon: 'üìñ' }
      ];

      const saveFirebaseConfig = () => {
        if (!firebaseUrl.trim() || firebaseUrl === DEFAULT_FIREBASE_URL) {
          alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –≤–∞—à Firebase URL');
          return;
        }
        
        let url = firebaseUrl.trim();
        if (!url.startsWith('http')) {
          url = 'https://' + url;
        }
        if (!url.endsWith('/')) {
          url = url + '/';
        }
        
        setFirebaseUrl(url);
        setGameState('menu');
      };

      const writeToFirebase = async (path, data) => {
        const response = await fetch(`${firebaseUrl}${path}.json`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        return await response.json();
      };

      const readFromFirebase = async (path) => {
        const response = await fetch(`${firebaseUrl}${path}.json`);
        return await response.json();
      };

      const startPolling = (code) => {
        if (pollIntervalRef.current) clearInterval(pollIntervalRef.current);
        
        pollIntervalRef.current = setInterval(async () => {
          try {
            const data = await readFromFirebase(`rooms/${code}`);
            if (data) {
              setPlayers(data.players || players);
              setGameState(data.gameState || gameState);
              setSelectedGenre(data.selectedGenre || '');
              setStory(data.story || '');
              setActionLog(data.actionLog || []);
              setCurrentPlayerIndex(data.currentPlayerIndex || 0);
              setChatMessages(data.chatMessages || []);
            }
          } catch (error) {
            console.error('Polling error:', error);
          }
        }, 2000);
      };

      useEffect(() => {
        return () => {
          if (pollIntervalRef.current) clearInterval(pollIntervalRef.current);
        };
      }, []);

      const createRoom = async () => {
        const code = Math.random().toString(36).substring(2, 8).toUpperCase();
        setRoomCode(code);
        setIsHost(true);
        setMyPlayerId(1);
        setConnectionStatus('hosting');
        
        const updatedPlayers = [...players];
        updatedPlayers[0].connected = true;
        setPlayers(updatedPlayers);
        
        try {
          await writeToFirebase(`rooms/${code}`, {
            host: true,
            players: updatedPlayers,
            gameState: 'lobby',
            selectedGenre: '',
            story: '',
            actionLog: [],
            currentPlayerIndex: 0,
            chatMessages: [],
            createdAt: Date.now()
          });
          setGameState('lobby');
          startPolling(code);
        } catch (error) {
          setConnectionStatus('error');
          alert('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–º–Ω–∞—Ç—ã');
        }
      };

      const joinRoom = async () => {
        if (!inputRoomCode.trim()) return;
        
        const code = inputRoomCode.toUpperCase();
        setRoomCode(code);
        setIsHost(false);
        setConnectionStatus('connecting');
        
        try {
          const roomData = await readFromFirebase(`rooms/${code}`);
          if (!roomData) throw new Error('Room not found');
          
          setPlayers(roomData.players);
          setGameState('lobby');
          setConnectionStatus('connected');
          startPolling(code);
        } catch (error) {
          setConnectionStatus('error');
          alert('–ö–æ–º–Ω–∞—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
        }
      };

      const updateFirebase = async (updates) => {
        if (!roomCode) return;
        try {
          const currentData = await readFromFirebase(`rooms/${roomCode}`);
          await writeToFirebase(`rooms/${roomCode}`, { ...currentData, ...updates });
        } catch (error) {
          console.error('Update error:', error);
        }
      };

      const selectPlayerSlot = async (slotId) => {
        if (players[slotId - 1].connected && myPlayerId !== slotId) {
          alert('–≠—Ç–æ—Ç —Å–ª–æ—Ç —É–∂–µ –∑–∞–Ω—è—Ç!');
          return;
        }
        
        const updatedPlayers = [...players];
        if (myPlayerId) updatedPlayers[myPlayerId - 1].connected = false;
        updatedPlayers[slotId - 1].connected = true;
        setMyPlayerId(slotId);
        setPlayers(updatedPlayers);
        await updateFirebase({ players: updatedPlayers });
      };

      const sendChatMessage = async () => {
        if (!chatInput.trim()) return;
        const newMessages = [...chatMessages, {
          player: `–ò–≥—Ä–æ–∫ ${myPlayerId}`,
          text: chatInput,
          timestamp: Date.now()
        }];
        setChatMessages(newMessages);
        setChatInput('');
        await updateFirebase({ chatMessages: newMessages });
      };

      const generateStory = async (genre) => {
        if (!isHost) return;
        setLoading(true);
        
        try {
          const prompts = {
            horror: '–∂—É—Ç–∫–∏–π —Ö–æ—Ä—Ä–æ—Ä —Å –º–∏—Å—Ç–∏—á–µ—Å–∫–∏–º–∏ —ç–ª–µ–º–µ–Ω—Ç–∞–º–∏',
            fantasy: '—ç–ø–∏—á–µ—Å–∫–æ–µ —Ñ—ç–Ω—Ç–µ–∑–∏ –ø—Ä–∏–∫–ª—é—á–µ–Ω–∏–µ',
            cyberpunk: '–º—Ä–∞—á–Ω—ã–π –∫–∏–±–µ—Ä–ø–∞–Ω–∫',
            postapoc: '–ø–æ—Å—Ç–∞–ø–æ–∫–∞–ª–∏–ø—Ç–∏—á–µ—Å–∫–∏–π –º–∏—Ä'
          };

          const response = await fetch("https://api.anthropic.com/v1/messages", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              model: "claude-sonnet-4-20250514",
              max_tokens: 2000,
              messages: [{
                role: "user",
                content: `–°–æ–∑–¥–∞–π —É–Ω–∏–∫–∞–ª—å–Ω—ã–π —Å—é–∂–µ—Ç –¥–ª—è —Ç–µ–∫—Å—Ç–æ–≤–æ–π RPG –≤ –∂–∞–Ω—Ä–µ ${prompts[genre]}. –í –∏–≥—Ä–µ 4 –∏–≥—Ä–æ–∫–∞. –û–ø–∏—à–∏ –Ω–∞—á–∞–ª—å–Ω—É—é –ª–æ–∫–∞—Ü–∏—é, —É–≥—Ä–æ–∑—É –∏ –ø–µ—Ä–≤—É—é —Å–∏—Ç—É–∞—Ü–∏—é (3-4 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è). –ù–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ.`
              }]
            })
          });

          const data = await response.json();
          const generatedStory = data.content[0].text;
          
          setStory(generatedStory);
          const newLog = [{ type: 'story', text: generatedStory }];
          setActionLog(newLog);
          setGameState('playing');
          
          await updateFirebase({
            story: generatedStory,
            actionLog: newLog,
            gameState: 'playing'
          });
        } catch (error) {
          console.error('Error:', error);
        }
        setLoading(false);
      };

      const handleAction = async () => {
        if (!playerAction.trim() || myPlayerId !== currentPlayerIndex + 1) return;

        const currentPlayer = players[currentPlayerIndex];
        setLoading(true);

        const newLog = [...actionLog, { 
          type: 'action', 
          player: currentPlayer.name, 
          text: playerAction 
        }];
        setActionLog(newLog);
        setPlayerAction('');

        try {
          const response = await fetch("https://api.anthropic.com/v1/messages", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              model: "claude-sonnet-4-20250514",
              max_tokens: 1500,
              messages: [{
                role: "user",
                content: `–¢—ã –º–∞—Å—Ç–µ—Ä DND. –ò–≥—Ä–æ–∫ ${currentPlayer.name} (–∑–¥–æ—Ä–æ–≤—å–µ: ${currentPlayer.health}, —Å–∏–ª–∞: ${currentPlayer.strength}) –¥–µ–ª–∞–µ—Ç: "${playerAction}". –û–ø–∏—à–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç (2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è). –î–æ–±–∞–≤—å JSON —Å –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏: {"healthChange": —á–∏—Å–ª–æ, "goldChange": —á–∏—Å–ª–æ}`
              }]
            })
          });

          const data = await response.json();
          let resultText = data.content[0].text;
          
          const jsonMatch = resultText.match(/\{[^}]*"healthChange"[^}]*\}/);
          let changes = { healthChange: 0, goldChange: 0 };
          
          if (jsonMatch) {
            try {
              changes = JSON.parse(jsonMatch[0]);
              resultText = resultText.replace(jsonMatch[0], '').trim();
            } catch (e) {}
          }

          const updatedPlayers = [...players];
          updatedPlayers[currentPlayerIndex] = {
            ...currentPlayer,
            health: Math.max(0, Math.min(100, currentPlayer.health + (changes.healthChange || 0))),
            gold: Math.max(0, currentPlayer.gold + (changes.goldChange || 0))
          };
          
          const finalLog = [...newLog, { type: 'result', text: resultText }];
          const nextPlayerIndex = (currentPlayerIndex + 1) % 4;
          
          setPlayers(updatedPlayers);
          setActionLog(finalLog);
          setCurrentPlayerIndex(nextPlayerIndex);

          await updateFirebase({
            actionLog: finalLog,
            currentPlayerIndex: nextPlayerIndex,
            players: updatedPlayers
          });
        } catch (error) {
          console.error('Error:', error);
        }
        setLoading(false);
      };

      const buyItem = async (item) => {
        if (!myPlayerId) return;
        
        const playerIndex = myPlayerId - 1;
        const currentPlayer = players[playerIndex];
        
        if (currentPlayer.gold < item.cost) {
          alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∑–æ–ª–æ—Ç–∞!');
          return;
        }

        const updatedPlayers = [...players];
        updatedPlayers[playerIndex].gold -= item.cost;
        updatedPlayers[playerIndex].inventory.push(item.name);
        
        if (item.effect === 'health') {
          updatedPlayers[playerIndex].health = Math.min(100, updatedPlayers[playerIndex].health + item.value);
        } else {
          updatedPlayers[playerIndex][item.effect] += item.value;
        }
        
        setPlayers(updatedPlayers);
        await updateFirebase({ players: updatedPlayers });
      };

      // Config screen
      if (gameState === 'config') {
        return (
          <div className="min-h-screen bg-gradient-to-b from-gray-900 via-purple-900 to-black text-white p-8">
            <div className="max-w-2xl mx-auto">
              <h1 className="text-5xl font-bold mb-8 text-center text-red-500">DND Online RPG</h1>
              <div className="bg-gray-800 border-2 border-gray-700 rounded-lg p-8">
                <h2 className="text-2xl font-bold mb-4">–ù–∞—Å—Ç—Ä–æ–π–∫–∞ Firebase</h2>
                <p className="text-gray-400 mb-4">–í–≤–µ–¥–∏—Ç–µ URL –≤–∞—à–µ–π Firebase Realtime Database</p>
                <input
                  type="text"
                  value={firebaseUrl}
                  onChange={(e) => setFirebaseUrl(e.target.value)}
                  placeholder="https://your-project.firebaseio.com"
                  className="w-full bg-gray-900 text-white border-2 border-gray-700 rounded p-4 mb-4"
                />
                <button
                  onClick={saveFirebaseConfig}
                  className="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-4 rounded-lg"
                >
                  –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                </button>
              </div>
            </div>
          </div>
        );
      }

      // Menu screen
      if (gameState === 'menu') {
        return (
          <div className="min-h-screen bg-gradient-to-b from-gray-900 via-purple-900 to-black text-white p-8">
            <div className="max-w-2xl mx-auto">
              <h1 className="text-5xl font-bold mb-12 text-center text-red-500">DND Online RPG</h1>
              <div className="space-y-4">
                <button
                  onClick={createRoom}
                  className="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-6 rounded-lg text-2xl"
                >
                  –°–æ–∑–¥–∞—Ç—å –∏–≥—Ä—É (–•–æ—Å—Ç)
                </button>
                <div className="bg-gray-800 border-2 border-gray-700 rounded-lg p-6">
                  <h3 className="text-xl font-bold mb-4">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ –∏–≥—Ä–µ</h3>
                  <input
                    type="text"
                    value={inputRoomCode}
                    onChange={(e) => setInputRoomCode(e.target.value.toUpperCase())}
                    placeholder="–ö–æ–¥ –∫–æ–º–Ω–∞—Ç—ã"
                    className="w-full bg-gray-900 text-white border-2 border-gray-700 rounded p-3 mb-4 text-center text-2xl"
                    maxLength={6}
                  />
                  <button
                    onClick={joinRoom}
                    className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-lg"
                  >
                    –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è
                  </button>
                </div>
              </div>
            </div>
          </div>
        );
      }

      // Lobby screen
      if (gameState === 'lobby') {
        return (
          <div className="min-h-screen bg-gradient-to-b from-gray-900 via-purple-900 to-black text-white p-8">
            <div className="max-w-6xl mx-auto">
              <h1 className="text-4xl font-bold mb-8 text-center text-red-500">–õ–æ–±–±–∏</h1>
              <div className="text-center mb-8">
                <div className="bg-green-900/30 border-2 border-green-500 rounded-lg p-4 inline-block">
                  <span className="text-xl font-bold">–ö–æ–¥: {roomCode}</span>
                  <button
                    onClick={() => { navigator.clipboard.writeText(roomCode); alert('–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!'); }}
                    className="ml-3 bg-green-600 px-3 py-1 rounded"
                  >
                    –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
                  </button>
                </div>
              </div>

              <div className="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                {players.map((p) => (
                  <button
                    key={p.id}
                    onClick={() => selectPlayerSlot(p.id)}
                    disabled={p.connected && myPlayerId !== p.id}
                    className={`p-6 rounded-lg border-2 ${
                      myPlayerId === p.id ? 'border-green-500 bg-green-900/30' :
                      p.connected ? 'border-gray-600 bg-gray-800/50' :
                      'border-gray-700 bg-gray-800/30 hover:border-blue-500'
                    }`}
                  >
                    <div className="text-4xl mb-2">üë§</div>
                    <h3 className="font-bold">{p.name}</h3>
                    <p className="text-sm">{myPlayerId === p.id ? '–í—ã' : p.connected ? '–ó–∞–Ω—è—Ç–æ' : '–°–≤–æ–±–æ–¥–Ω–æ'}</p>
                  </button>
                ))}
              </div>

              <div className="bg-gray-800 rounded-lg p-4 mb-8 max-h-48 overflow-y-auto">
                <h3 className="font-bold mb-3">–ß–∞—Ç</h3>
                <div className="space-y-2 mb-3">
                  {chatMessages.map((msg, i) => (
                    <div key={i} className="text-sm">
                      <span className="text-blue-400 font-bold">{msg.player}:</span> {msg.text}
                    </div>
                  ))}
                </div>
                <div className="flex gap-2">
                  <input
                    type="text"
                    value={chatInput}
                    onChange={(e) => setChatInput(e.target.value)}
                    onKeyPress={(e) => e.key === 'Enter' && sendChatMessage()}
                    className="flex-1 bg-gray-900 text-white border rounded p-2"
                    placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..."
                  />
                  <button onClick={sendChatMessage} className="bg-blue-600 px-4 rounded">
                    ‚Üí
                  </button>
                </div>
              </div>

              {isHost && (
                <button
                  onClick={() => { setGameState('setup'); updateFirebase({ gameState: 'setup' }); }}
                  disabled={players.filter(p => p.connected).length < 2}
                  className="w-full bg-red-600 hover:bg-red-700 disabled:bg-gray-600 text-white font-bold py-4 rounded-lg"
                >
                  {players.filter(p => p.connected).length < 2 ? '–ú–∏–Ω–∏–º—É–º 2 –∏–≥—Ä–æ–∫–∞' : '–ù–∞—á–∞—Ç—å'}
                </button>
              )}
            </div>
          </div>
        );
      }

      // Setup screen
      if (gameState === 'setup') {
        return (
          <div className="min-h-screen bg-gradient-to-b from-gray-900 via-purple-900 to-black text-white p-8">
            <div className="max-w-4xl mx-auto">
              <h1 className="text-4xl font-bold mb-12 text-center text-red-500">–í—ã–±–µ—Ä–∏—Ç–µ –∂–∞–Ω—Ä</h1>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                {genres.map(g => (
                  <button
                    key={g.id}
                    onClick={() => { setSelectedGenre(g.id); if (isHost) updateFirebase({ selectedGenre: g.id }); }}
                    disabled={!isHost}
                    className={`p-6 rounded-lg border-2 ${
                      selectedGenre === g.id ? 'border-red-500 bg-red-900/30' : 'border-gray-700 bg-gray-800/50'
                    }`}
                  >
                    <div className="text-4xl mb-3">{g.icon}</div>
                    <h3 className="text-2xl font-bold mb-2">{g.name}</h3>
                    <p className="text-gray-400">{g.desc}</p>
                  </button>
                ))}
              </div>
              {isHost && selectedGenre && (
                <button
                  onClick={() => generateStory(selectedGenre)}
                  disabled={loading}
                  className="mt-8 w-full bg-red-600 hover:bg-red-700 text-white font-bold py-4 rounded-lg"
                >
                  {loading ? '–ì–µ–Ω–µ—Ä–∞—Ü–∏—è...' : '–ù–∞—á–∞—Ç—å –ø—Ä–∏–∫–ª—é—á–µ–Ω–∏–µ'}
                </button>
              )}
            </div>
          </div>
        );
      }

      // Shop screen
      if (gameState === 'shop') {
        return (
          <div className="min-h-screen bg-gradient-to-b from-gray-900 via-purple-900 to-black text-white p-8">
            <div className="max-w-6xl mx-auto">
              <h2 className="text-4xl font-bold mb-8 text-center">–ú–∞–≥–∞–∑–∏–Ω</h2>
              <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                {shopItems.map(item => (
                  <div key={item.id} className="bg-gray-800 border-2 border-gray-700 rounded-lg p-6">
                    <div className="text-4xl mb-3">{item.icon}</div>
                    <h3 className="text-xl font-bold mb-2">{item.name}</h3>
                    <p className="text-yellow-500 mb-4">üí∞ {item.cost} –∑–æ–ª–æ—Ç–∞</p>
                    <button
                      onClick={() => buyItem(item)}
                      disabled={!myPlayerId || players[myPlayerId - 1]?.gold < item.cost}
                      className="w-full bg-green-600 hover:bg-green-700 disabled:bg-gray-600 text-white font-bold py-2 rounded"
                    >
                      –ö—É–ø–∏—Ç—å
                    </button>
                  </div>
                ))}
              </div>
              <button
                onClick={() => setGameState('playing')}
                className="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-lg"
              >
                –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –∏–≥—Ä–µ
              </button>
            </div>
          </div>
        );
      }

      // Playing screen
      return (
        <div className="min-h-screen bg-gradient-to-b from-gray-900 via-purple-900 to-black text-white p-4">
          <div className="max-w-7xl mx-auto">
            <div className="flex justify-between items-center mb-6">
              <h1 className="text-3xl font-bold text-red-500">DND RPG</h1>
              <div className="flex gap-3">
                <div className="bg-gray-800 px-4 py-2 rounded">–ö–æ–º–Ω–∞—Ç–∞: {roomCode}</div>
                <button
                  onClick={() => setGameState('shop')}
                  className="bg-yellow-600 hover:bg-yellow-700 px-4 py-2 rounded"
                >
                  –ú–∞–≥–∞–∑–∏–Ω
                </button>
              </div>
            </div>

            <div className="grid grid-cols-1 lg:grid-cols-4 gap-4 mb-6">
              {players.filter(p => p.connected).map((p) => {
                const idx = players.indexOf(p);
                return (
                  <div
                    key={p.id}
                    className={`bg-gray-800 border-2 rounded-lg p-4 ${
                      idx === currentPlayerIndex ? 'border-red-500' :
                      p.id === myPlayerId ? 'border-green-500' : 'border-gray-700'
                    }`}
                  >
                    <div className="flex justify-between mb-3">
                      <h3 className="font-bold">{p.name}{p.id === myPlayerId && ' (–í—ã)'}</h3>
                      {idx === currentPlayerIndex && <span className="text-xs bg-red-600 px-2 py-1 rounded">–•–û–î</span>}
                    </div>
                    <div className="space-y-2 text-sm">
                      <div className="flex justify-between"><span>‚ù§Ô∏è –ó–¥–æ—Ä–æ–≤—å–µ</span><span>{p.health}</span></div>
                      <div className="flex justify-between"><span>‚öîÔ∏è –°–∏–ª–∞</span><span>{p.strength}</span></div>
                      <div className="flex justify-between"><span>‚ö° –õ–æ–≤–∫–æ—Å—Ç—å</span><span>{p.agility}</span></div>
                      <div className="flex justify-between"><span>üõ°Ô∏è –ò–Ω—Ç–µ–ª–ª–µ–∫—Ç</span><span>{p.intelligence}</span></div>
                      <div className="flex justify-between border-t pt-2"><span>üí∞ –ó–æ–ª–æ—Ç–æ</span><span className="text-yellow-500">{p.gold}</span></div>
                    </div>
                  </div>
                );
              })}
            </div>

            <div className="bg-gray-800 border-2 border-gray-700 rounded-lg p-6 mb-6 max-h-96 overflow-y-auto">
              <h2 className="text-2xl font-bold mb-4 text-red-400">–ò—Å—Ç–æ—Ä–∏—è</h2>
              {actionLog.map((log, i) => (
                <div key={i} className="mb-4">
                  {log.type === 'story' && <p className="italic bg-purple-900/30 p-4 rounded">{log.text}</p>}
                  {log.type === 'action' && <p className="text-blue-400"><strong>{log.player}:</strong> {log.text}</p>}
                  {log.type === 'result' && <p className="bg-gray-900/50 p-3 rounded mt-2">{log.text}</p>}
                </div>
              ))}
            </div>

            <div className="bg-gray-800 border-2 border-red-500 rounded-lg p-6">
              <h3 className="text-xl font-bold mb-4 text-red-400">
                –•–æ–¥: {players[currentPlayerIndex]?.name}
                {myPlayerId === currentPlayerIndex + 1 && ' (–í–∞—à —Ö–æ–¥!)'}
              </h3>
              <textarea
                value={playerAction}
                onChange={(e) => setPlayerAction(e.target.value)}
                placeholder={myPlayerId === currentPlayerIndex + 1 ? "–í–∞—à–µ –¥–µ–π—Å—Ç–≤–∏–µ..." : "–û–∂–∏–¥–∞–Ω–∏–µ..."}
                className="w-full bg-gray-900 text-white border-2 border-gray-700 rounded p-4 mb-4 min-h-32"
                disabled={loading || myPlayerId !== currentPlayerIndex + 1}
              />
              <button
                onClick={handleAction}
                disabled={loading || !playerAction.trim() || myPlayerId !== currentPlayerIndex + 1}
                className="w-full bg-red-600 hover:bg-red-700 disabled:bg-gray-600 text-white font-bold py-3 rounded-lg"
              >
                {loading ? '–û–±—Ä–∞–±–æ—Ç–∫–∞...' : myPlayerId === currentPlayerIndex + 1 ? '–í—ã–ø–æ–ª–Ω–∏—Ç—å' : '–ù–µ –≤–∞—à —Ö–æ–¥'}
              </button>
            </div>
          </div>
        </div>
      );
    };

    ReactDOM.render(<DNDGame />, document.getElementById('root'));
  </script>
</body>
</html>
