<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DND Online RPG</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // Lucide icons as simple SVG components
    const Skull = () => <svg className="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-2-13h4v6h-4zm0 8h4v2h-4z" /></svg>;
    const Heart = ({ className }) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z" /></svg>;
    const Coins = ({ className }) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" strokeWidth={2}/></svg>;
    const ShoppingBag = ({ className }) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M16 11V7a4 4 0 0 0-8 0v4M5 9h14l1 12H4L5 9z" /></svg>;
    const Sword = ({ className }) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M20 4L4 20m0-16l16 16" /></svg>;
    const Shield = ({ className }) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 2L4 6v6c0 5 4 9 8 12 4-3 8-7 8-12V6l-8-4z" /></svg>;
    const Zap = ({ className }) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 2L3 14h8l-1 8 10-12h-8l1-8z" /></svg>;
    const User = ({ className }) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2M12 11a4 4 0 1 0 0-8 4 4 0 0 0 0 8z" /></svg>;
    const Wifi = ({ className }) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 20h.01M8.1 16.1a5 5 0 0 1 7.8 0M3.5 11.5a11 11 0 0 1 17 0" /></svg>;
    const WifiOff = ({ className }) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M1 1l22 22M16.7 16.7a5 5 0 0 1-7.4 0M3.5 11.5a11 11 0 0 1 3.2-2.4m6.6 0a11 11 0 0 1 7.2 2.4" /></svg>;
    const Copy = ({ className }) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><rect x="9" y="9" width="13" height="13" rx="2" ry="2" strokeWidth={2}/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1" strokeWidth={2}/></svg>;
    const Users = ({ className }) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2M23 21v-2a4 4 0 0 0-3-3.87M13 7a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM16 3.13a4 4 0 0 1 0 7.75" /></svg>;
    const Settings = ({ className }) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3" strokeWidth={2}/><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 1v6m0 6v6m-9-9h6m6 0h6" /></svg>;

    // ПОМЕНЯЙТЕ ЭТО НА ВАШ FIREBASE URL
    const DEFAULT_FIREBASE_URL = 'https://games-1e88e-default-rtdb.firebaseio.com/';

    const DNDGame = () => {
      const [gameState, setGameState] = useState('config');
      const [firebaseUrl, setFirebaseUrl] = useState(DEFAULT_FIREBASE_URL);
      const [isHost, setIsHost] = useState(false);
      const [roomCode, setRoomCode] = useState('');
      const [inputRoomCode, setInputRoomCode] = useState('');
      const [myPlayerId, setMyPlayerId] = useState(null);
      const [selectedGenre, setSelectedGenre] = useState('');
      const [story, setStory] = useState('');
      const [loading, setLoading] = useState(false);
      const [currentPlayerIndex, setCurrentPlayerIndex] = useState(0);
      const [actionLog, setActionLog] = useState([]);
      const [playerAction, setPlayerAction] = useState('');
      const [connectionStatus, setConnectionStatus] = useState('disconnected');
      const [chatMessages, setChatMessages] = useState([]);
      const [chatInput, setChatInput] = useState('');
      
      const pollIntervalRef = useRef(null);
      
      const [players, setPlayers] = useState([
        { id: 1, name: 'Игрок 1', health: 100, strength: 10, agility: 10, intelligence: 10, gold: 50, inventory: [], connected: false },
        { id: 2, name: 'Игрок 2', health: 100, strength: 10, agility: 10, intelligence: 10, gold: 50, inventory: [], connected: false },
        { id: 3, name: 'Игрок 3', health: 100, strength: 10, agility: 10, intelligence: 10, gold: 50, inventory: [], connected: false },
        { id: 4, name: 'Игрок 4', health: 100, strength: 10, agility: 10, intelligence: 10, gold: 50, inventory: [], connected: false }
      ]);

      const genres = [
        { id: 'horror', name: 'Хоррор', desc: 'Мрачные коридоры, древнее зло и ужасающие тайны', icon: '🏚️' },
        { id: 'fantasy', name: 'Фэнтези', desc: 'Магия, драконы и эпические приключения', icon: '🐉' },
        { id: 'cyberpunk', name: 'Киберпанк', desc: 'Неоновые улицы, киборги и корпоративные заговоры', icon: '🤖' },
        { id: 'postapoc', name: 'Постапокалипсис', desc: 'Выживание в разрушенном мире', icon: '☢️' }
      ];

      const shopItems = [
        { id: 1, name: 'Зелье здоровья', cost: 20, effect: 'health', value: 30, icon: '🧪' },
        { id: 2, name: 'Меч', cost: 50, effect: 'strength', value: 5, icon: '⚔️' },
        { id: 3, name: 'Легкая броня', cost: 40, effect: 'health', value: 20, icon: '🛡️' },
        { id: 4, name: 'Амулет удачи', cost: 60, effect: 'agility', value: 5, icon: '💎' },
        { id: 5, name: 'Книга заклинаний', cost: 55, effect: 'intelligence', value: 5, icon: '📖' }
      ];

      const saveFirebaseConfig = () => {
        if (!firebaseUrl.trim()) {
          alert('Пожалуйста, введите URL Firebase');
          return;
        }
        
        let url = firebaseUrl.trim();
        if (!url.startsWith('http')) {
          url = 'https://' + url;
        }
        if (!url.endsWith('/')) {
          url = url + '/';
        }
        
        setFirebaseUrl(url);
        setGameState('menu');
      };

      const writeToFirebase = async (path, data) => {
        try {
          const response = await fetch(`${firebaseUrl}${path}.json`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
          
          if (!response.ok) {
            throw new Error('Firebase write failed');
          }
          
          return await response.json();
        } catch (error) {
          console.error('Firebase write error:', error);
          throw error;
        }
      };

      const readFromFirebase = async (path) => {
        try {
          const response = await fetch(`${firebaseUrl}${path}.json`);
          
          if (!response.ok) {
            throw new Error('Firebase read failed');
          }
          
          return await response.json();
        } catch (error) {
          console.error('Firebase read error:', error);
          throw error;
        }
      };

      const startPolling = (code) => {
        if (pollIntervalRef.current) {
          clearInterval(pollIntervalRef.current);
        }
        
        pollIntervalRef.current = setInterval(async () => {
          try {
            const data = await readFromFirebase(`rooms/${code}`);
            if (data) {
              setPlayers(data.players || players);
              setGameState(data.gameState || gameState);
              setSelectedGenre(data.selectedGenre || '');
              setStory(data.story || '');
              setActionLog(data.actionLog || []);
              setCurrentPlayerIndex(data.currentPlayerIndex || 0);
              setChatMessages(data.chatMessages || []);
            }
          } catch (error) {
            console.error('Polling error:', error);
          }
        }, 2000);
      };

      useEffect(() => {
        return () => {
          if (pollIntervalRef.current) {
            clearInterval(pollIntervalRef.current);
          }
        };
      }, []);

      const createRoom = async () => {
        const code = Math.random().toString(36).substring(2, 8).toUpperCase();
        setRoomCode(code);
        setIsHost(true);
        setMyPlayerId(1);
        setConnectionStatus('hosting');
        
        const updatedPlayers = [...players];
        updatedPlayers[0].connected = true;
        setPlayers(updatedPlayers);
        
        const roomData = {
          host: true,
          players: updatedPlayers,
          gameState: 'lobby',
          selectedGenre: '',
          story: '',
          actionLog: [],
          currentPlayerIndex: 0,
          chatMessages: [],
          createdAt: Date.now()
        };
        
        try {
          await writeToFirebase(`rooms/${code}`, roomData);
          setGameState('lobby');
          startPolling(code);
        } catch (error) {
          setConnectionStatus('error');
          alert('Ошибка создания комнаты. Проверьте URL Firebase.');
        }
      };

      const joinRoom = async () => {
        if (!inputRoomCode.trim()) return;
        
        const code = inputRoomCode.toUpperCase();
        setRoomCode(code);
        setIsHost(false);
        setConnectionStatus('connecting');
        
        try {
          const roomData = await readFromFirebase(`rooms/${code}`);
          
          if (!roomData) {
            throw new Error('Room not found');
          }
          
          setPlayers(roomData.players);
          setGameState('lobby');
          setConnectionStatus('connected');
          startPolling(code);
        } catch (error) {
          setConnectionStatus('error');
          alert('Комната не найдена. Проверьте код.');
        }
      };

      const updateFirebase = async (updates) => {
        if (!roomCode) return;
        
        try {
          const currentData = await readFromFirebase(`rooms/${roomCode}`);
          const newData = { ...currentData, ...updates };
          await writeToFirebase(`rooms/${roomCode}`, newData);
        } catch (error) {
          console.error('Update error:', error);
        }
      };

      const selectPlayerSlot = async (slotId) => {
        if (players[slotId - 1].connected && myPlayerId !== slotId) {
          alert('Этот слот уже занят!');
          return;
        }
        
        const updatedPlayers = [...players];
        
        if (myPlayerId) {
          updatedPlayers[myPlayerId - 1].connected = false;
        }
        
        updatedPlayers[slotId - 1].connected = true;
        setMyPlayerId(slotId);
        setPlayers(updatedPlayers);
        
        await updateFirebase({ players: updatedPlayers });
      };

      const sendChatMessage = async () => {
        if (!chatInput.trim()) return;
        
        const message = {
          player: `Игрок ${myPlayerId}`,
          text: chatInput,
          timestamp: Date.now()
        };
        
        const newMessages = [...chatMessages, message];
        setChatMessages(newMessages);
        setChatInput('');
        
        await updateFirebase({ chatMessages: newMessages });
      };

      const generateStory = async (genre) => {
        if (!isHost) return;
        
        setLoading(true);
        try {
          const genrePrompts = {
            horror: 'жуткий хоррор с мистическими элементами, заброшенными местами и древним злом',
            fantasy: 'эпическое фэнтези приключение с магией, мифическими существами и древними артефактами',
            cyberpunk: 'мрачный киберпанк с корпоративными интригами, хакерами и технологическим беспределом',
            postapoc: 'постапокалиптический мир с выживанием, мутантами и поиском ресурсов'
          };

          const response = await fetch("https://api.anthropic.com/v1/messages", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              model: "claude-sonnet-4-20250514",
              max_tokens: 2000,
              messages: [
                {
                  role: "user",
                  content: `Создай уникальный сюжет для текстовой RPG игры в жанре ${genrePrompts[genre]}. 
                  
                  В игре участвуют 4 игрока. Опиши:
                  1. Начальную локацию и атмосферу (2-3 предложения)
                  2. Главную угрозу или цель приключения
                  3. Первую ситуацию, с которой столкнулись игроки
                  
                  Сделай описание атмосферным и захватывающим. Текст должен быть на русском языке.`
                }
              ]
            })
          });

          const data = await response.json();
          const generatedStory = data.content[0].text;
          
          setStory(generatedStory);
          const newLog = [{ type: 'story', text: generatedStory }];
          setActionLog(newLog);
          setGameState('playing');
          
          await updateFirebase({
            story: generatedStory,
            actionLog: newLog,
            gameState: 'playing'
          });
        } catch (error) {
          console.error('Error generating story:', error);
          setStory('Ошибка при генерации сюжета. Попробуйте еще раз.');
        }
        setLoading(false);
      };

      const handleAction = async () => {
        if (!playerAction.trim() || myPlayerId !== currentPlayerIndex + 1) return;

        const currentPlayer = players[currentPlayerIndex];
        setLoading(true);

        const newLog = [...actionLog, { 
          type: 'action', 
          player: currentPlayer.name, 
          text: playerAction 
        }];
        setActionLog(newLog);
        setPlayerAction('');

        try {
          const gameHistory = actionLog.map(log => {
            if (log.type === 'story') return `Сюжет: ${log.text}`;
            if (log.type === 'action') return `${log.player}: ${log.text}`;
            if (log.type === 'result') return `Результат: ${log.text}`;
            return '';
          }).join('\\n\\n');

          const playersInfo = players.map(p => 
            `${p.name}: Здоровье ${p.health}, Сила ${p.strength}, Ловкость ${p.agility}, Интеллект ${p.intelligence}, Золото ${p.gold}`
          ).join('\\n');

          const response = await fetch("https://api.anthropic.com/v1/messages", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              model: "claude-sonnet-4-20250514",
              max_tokens: 1500,
              messages: [
                {
                  role: "user",
                  content: `Ты - мастер DND игры. Вот текущее состояние игры:

ИСТОРИЯ ИГРЫ:
${gameHistory}

СОСТОЯНИЕ ИГРОКОВ:
${playersInfo}

ДЕЙСТВИЕ ТЕКУЩЕГО ИГРОКА (${currentPlayer.name}):
${playerAction}

Опиши результат этого действия (2-4 предложения). Включи:
1. Что произошло в результате действия
2. Если нужно, измени характеристики игрока (урон/исцеление/награда)
3. Развитие сюжета

В конце ответа добавь в формате JSON изменения характеристик (если есть):
{"healthChange": число, "goldChange": число}

Если изменений нет, используй 0. Пиши на русском языке.`
                }
              ]
            })
          });

          const data = await response.json();
          let resultText = data.content[0].text;
          
          const jsonMatch = resultText.match(/\\{[^}]*"healthChange"[^}]*\\}/);
          let changes = { healthChange: 0, goldChange: 0 };
          
          if (jsonMatch) {
            try {
              changes = JSON.parse(jsonMatch[0]);
              resultText = resultText.replace(jsonMatch[0], '').trim();
            } catch (e) {
              console.log('Could not parse changes');
            }
          }

          const updatedPlayers = [...players];
          updatedPlayers[currentPlayerIndex] = {
            ...currentPlayer,
            health: Math.max(0, Math.min(100, currentPlayer.health + (changes.healthChange || 0))),
            gold: Math.max(0, currentPlayer.gold + (changes.goldChange || 0))
          };
          
          const finalLog = [...newLog, { type: 'result', text: resultText }];
          const nextPlayerIndex = (currentPlayerIndex + 1) % 4;
          
          setPlayers(updatedPlayers);
          setActionLog(finalLog);
          setCurrentPlayerIndex(nextPlayerIndex);

          await updateFirebase({
            actionLog: finalLog,
            currentPlayerIndex: nextPlayerIndex,
            players: updatedPlayers
          });
        } catch (error) {
          console.error('Error processing action:', error);
          setActionLog([...newLog, { type: 'result', text: 'Ошибка при обработке действия.' }]);
        }
        setLoading(false);
      };

      const buyItem = async (item) => {
        if (myPlayerId === null) return;
        
        const playerIndex = myPlayerId - 1;
        const currentPlayer = players[playerIndex];
        
        if (currentPlayer.gold < item.cost) {
          alert('Недостаточно золота!');
          return;
        }

        const updatedPlayers = [...players];
        const playerToUpdate = updatedPlayers[playerIndex];
        
        playerToUpdate.gold -= item.cost;
        playerToUpdate.inventory.push(item.name);
        
        if (item.effect === 'health') {
          playerToUpdate.health = Math.min(100, playerToUpdate.health + item.value);
        } else if (item.effect === 'strength') {
          playerToUpdate.strength += item.value;
        } else if (item.effect === 'agility') {
          playerToUpdate.agility += item.value;
        } else if (item.effect === 'intelligence') {
          playerToUpdate.intelligence += item.value;
        }
        
        setPlayers(updatedPlayers);
        await updateFirebase({ players: updatedPlayers });
      };

      const copyRoomCode = () => {
        navigator.clipboard.writeText(roomCode);
        alert('Код комнаты скопирован!');
      };

      const handleGenreSelect = async (genreId) => {
        setSelectedGenre(genreId);
        if (isHost) {
          await updateFirebase({ selectedGenre: genreId });
        }
      };

      const startGame = async () => {
        if (!isHost) return;
        setGameState('setup');
        await updateFirebase({ gameState: 'setup' });
      };

      // Render logic here - все экраны игры
      // ... (остальной код с рендером игры точно такой же как в артефакте)
      
      if (gameState === 'config') {
        return (
          <div className="min-h-screen bg-gradient-to-b from-gray-900 via-purple-900 to-black text-white p-8">
            <div className="max-w-2xl mx-auto">
              <div className="text-center mb-12">
                <Settings className="w-20 h-20 mx-auto mb-4 text-blue-500" />
                <h1 className="text-5xl font-bold mb-4 text-red-500">Настройка Firebase</h1>
                <p className="text-xl text-gray-300 mb-8">Введите URL вашей Firebase Realtime Database</p>
              </div>

              <div className="bg-gray-800 border-2 border-gray-700 rounded-lg p-8 mb-6">
                <input
                  type="text"
                  value={firebaseUrl}
                  onChange={(e) => setFirebaseUrl(e.target.value)}
                  placeholder="https://your-project.firebaseio.com"
                  className="w-full bg-gray-900 text-white border-2 border-gray-700 rounded p-4 mb-4 text-center"
                />
                
                <button
                  onClick={saveFirebaseConfig}
                  className="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-4 px-6 rounded-lg text-xl transition-all"
                >
                  Сохранить и продолжить
                </button>
              </div>
            </div>
          </div>
        );
      }

      // Остальные экраны игры (menu, lobby, setup, shop, playing)
      // Полный код слишком большой для одного файла - продолжу в следующем артефакте

      return <div>Loading...</div>;
    };

    ReactDOM.render(<DNDGame />, document.getElementById('root'));
  </script>
</body>
</html>
